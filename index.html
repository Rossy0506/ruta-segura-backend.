<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruta Segura Pro - Sistema de Auxilio</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #1a1a2e; --danger: #e74c3c; --success: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        .app-header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #map { height: calc(100vh - 180px); width: 100%; }
        .action-bar { padding: 15px; display: flex; flex-direction: column; gap: 10px; background: white; border-top: 2px solid #ddd; }
        .btn { border: none; border-radius: 8px; padding: 15px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; }
        .btn-panic { background: var(--danger); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4); animation: pulse 2s infinite; }
        .btn-call { background: #34495e; text-decoration: none; text-align: center; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        .status-indicator { font-size: 12px; text-align: center; padding: 5px; background: #eee; }
    </style>
</head>
<body>

<div class="app-header">
    <h3 style="margin:0;">üö® RUTA SEGURA</h3>
    <small>Central de Seguridad para Taxistas</small>
</div>

<div id="map"></div>

<div class="action-bar">
    <button class="btn btn-panic" onclick="enviarAlerta()">üÜò ENVIAR ALERTA DE AUXILIO</button>
    <a href="tel:105" class="btn btn-call">üìû LLAMAR A LA POLIC√çA (105)</a>
</div>

<div class="status-indicator" id="status">Esperando conexi√≥n...</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // CONFIGURACI√ìN
    const RENDER_URL = "https://ruta-segura-backend-hz7t.onrender.com";
    var map = L.map('map').setView([-12.0464, -77.0428], 14); // Inicio en Lima
    var grupoMarcadores = L.layerGroup().addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // FUNCI√ìN: ENVIAR ALERTA
    function enviarAlerta() {
        const btn = document.querySelector('.btn-panic');
        const status = document.getElementById('status');
        
        btn.disabled = true;
        status.innerText = "Localizando unidad...";

        navigator.geolocation.getCurrentPosition(function(pos) {
            const payload = {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                tipo: "BOT√ìN DE P√ÅNICO ACTIVADO",
                usuario: "Unidad_" + Math.floor(Math.random() * 9000 + 1000)
            };

            fetch(`${RENDER_URL}/reportar`, {
                method: 'POST',
                mode: 'cors', // Soluci√≥n al error de conexi√≥n
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                status.innerText = "‚úÖ ¬°ALERTA RECIBIDA EN CENTRAL!";
                status.style.color = "green";
                L.marker([payload.lat, payload.lng]).addTo(grupoMarcadores)
                    .bindPopup("<b>TU AUXILIO</b><br>Ayuda en camino").openPopup();
                map.setView([payload.lat, payload.lng], 16);
                setTimeout(() => { btn.disabled = false; }, 5000);
            })
            .catch(err => {
                console.error(err);
                status.innerText = "‚ùå Error de Red. Reintente.";
                btn.disabled = false;
            });
        }, function() {
            alert("Por favor, activa el GPS del celular.");
            btn.disabled = false;
        });
    }

    // FUNCI√ìN: CARGAR ALERTAS DE OTROS (Cada 8 segundos)
    function sincronizarAlertas() {
        fetch(`${RENDER_URL}/alertas`)
            .then(res => res.json())
            .then(data => {
                grupoMarcadores.clearLayers();
                data.forEach(a => {
                    L.marker([a.lat, a.lng]).addTo(grupoMarcadores)
                        .bindPopup(`<b>Peligro:</b> ${a.tipo}<br><b>ID:</b> ${a.usuario}`);
                });
                document.getElementById('status').innerText = "üì° Conectado y Sincronizado";
            })
            .catch(() => { document.getElementById('status').innerText = "‚ö†Ô∏è Reconectando..."; });
    }

    setInterval(sincronizarAlertas, 8000);
    sincronizarAlertas();
</script>

</body>
</html>