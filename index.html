<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruta Segura - Dashboard Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f4f4f9; }
        #map { height: 75vh; width: 100%; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .header { background: #1a1a2e; color: white; padding: 15px; text-align: center; border-bottom: 4px solid #e74c3c; }
        .controls { display: flex; justify-content: center; padding: 20px; gap: 10px; background: white; }
        .btn-alert { 
            background: #e74c3c; color: white; border: none; padding: 15px 30px; 
            font-size: 18px; font-weight: bold; border-radius: 50px; cursor: pointer;
            transition: transform 0.2s, background 0.2s; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }
        .btn-alert:active { transform: scale(0.95); background: #c0392b; }
        .status-bar { font-size: 12px; color: #666; text-align: center; padding: 5px; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0;">ðŸš– RUTA SEGURA</h2>
    <div style="font-size: 14px; opacity: 0.8;">Panel de Seguridad en Tiempo Real</div>
</div>

<div class="controls">
    <button class="btn-alert" onclick="enviarAlerta()">ðŸš¨ ENVIAR ALERTA DE AUXILIO</button>
</div>

<div id="map"></div>
<div class="status-bar" id="status">Conectado al servidor global: Render âœ…</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. ConfiguraciÃ³n del Mapa (Inicia en Lima)
    var map = L.map('map').setView([-12.0464, -77.0428], 14);
    var marcadores = L.layerGroup().addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // URL DE TU SERVIDOR EN RENDER
    const API_URL = "https://ruta-segura-backend-hz7t.onrender.com";

    // 2. FunciÃ³n para enviar alertas
    function enviarAlerta() {
        document.getElementById('status').innerText = "Obteniendo ubicaciÃ³n...";
        
        if (!navigator.geolocation) {
            alert("Tu navegador no permite ver tu ubicaciÃ³n.");
            return;
        }

        navigator.geolocation.getCurrentPosition(function(pos) {
            const alerta = {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                tipo: "S.O.S TAXISTA",
                usuario: "Unidad_Movil_" + Math.floor(Math.random() * 1000)
            };

            fetch(`${API_URL}/reportar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(alerta)
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('status').innerText = "Â¡Alerta enviada correctamente!";
                L.marker([alerta.lat, alerta.lng]).addTo(marcadores)
                    .bindPopup("<b>Â¡TU ALERTA!</b><br>Ayuda en camino.").openPopup();
                map.setView([alerta.lat, alerta.lng], 16);
                setTimeout(actualizarMapa, 2000); // Recargar para ver otras alertas
            })
            .catch(err => {
                console.error(err);
                alert("Error al conectar con Render. Revisa los logs.");
            });
        }, function() {
            alert("No se pudo obtener tu ubicaciÃ³n. Activa el GPS.");
        });
    }

    // 3. FunciÃ³n para ver alertas de otros taxistas (Recarga automÃ¡tica cada 10 seg)
    function actualizarMapa() {
        fetch(`${API_URL}/alertas`)
            .then(res => res.json())
            .then(alertas => {
                marcadores.clearLayers();
                alertas.forEach(a => {
                    L.marker([a.lat, a.lng])
                        .addTo(marcadores)
                        .bindPopup(`<b>Incidente:</b> ${a.tipo}<br><b>Usuario:</b> ${a.usuario}`);
                });
            })
            .catch(err => console.log("Buscando nuevas alertas..."));
    }

    // Actualizar cada 10 segundos automÃ¡ticamente
    setInterval(actualizarMapa, 10000);
    actualizarMapa();
</script>

</body>
</html>